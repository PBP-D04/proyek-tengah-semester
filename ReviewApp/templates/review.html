{% extends 'base.html' %}

{% block content %}
{% load static %}

<style>

  .form-group {
    margin-bottom: 2px;

  }

  .btn-success {
  background-color: #460C90;
  border-color: #460C90;
  margin-top: 10px;
  }

</style>



<script src="{% static 'js/firebase-upload.js' %}">

</script>


<!-- Reviews List Modal -->
<div class="modal fade" id="reviewsModal" tabindex="-1" aria-labelledby="reviewsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewsModalLabel">Reviews</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Review Form Modal -->
<div class="modal fade" id="reviewFormModal" tabindex="-1" aria-labelledby="reviewFormModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewFormModalLabel">Add New Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" id="add-review-form" class="space-y-6" action="#">
          {% csrf_token %}
          <table>
              {{ form.as_table }}
              <tr>
                  <td></td>
                  <td>
                      <input type="submit" value="Add Review" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 hover:cursor-pointer"/>
                  </td>
              </tr>
          </table>
      </div>
    </div>
  </div>
</div>

<!-- Trigger buttons -->
<div class="container mt-5">
  <h5 class="text-uppercase font-weight-bold">Reviews</h5>
  <hr class="mt-0 pt-0">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#reviewFormModal">
      Make New Review
    </button>
</div>

</div>
<h2 class="mt-10 mb-4 text-3xl font-bold mx-8">Recent Reviews All Around The World:</h2>
<div id="reviews-container" class="flex flex-col gap-8 mx-10 mb-10">
</div>




<script>

  async function getReviews() {
        return fetch("{% url 'ReviewApp:get_review_json' %}").then((res) => res.json())
  }

  // async function refreshReviews() {
  //   const reviewsContainer = document.getElementById("reviews-container");
  //   const tmp = await fetch("/review/get-review")
  //   const data = await tmp.json()
  //   console.log("data")
  //   console.log(data.reviews)
  //   data.reviews.forEach(review => {
  //     console.log(review.user);
  //     console.log(review.content);
  //     reviewsContainer.innerHTML += "\n" +
  //     `<div class="shadow-xl w-full rounded-xl bg-zinc-100 px-4 py-6">` +
  //       `<p class="opacity-40">${review.user} gave <span class="font-bold opacity-100">${review.rating}</span> star to</p>` +
  //       `<h5 class="text-xl font-bold">${review.book}</h5>` +
  //       `<p>${review.content}</p>` +
  //     `</div>`
  //   })
  // }
  // refreshReviews();

  document.getElementById('add-review-form').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    try {
        const response = await fetch('/review/create-review/', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (response.ok && result) { // Memeriksa apakah respons OK dan result ada
            console.log('Review added:', result);
            refreshReviews();
            $('#reviewFormModal').modal('hide');
            this.reset();
            alert("Anda berhasil menambahkan review");
        } else {
            // Menangani jika server mengirimkan respons OK tapi ada error dalam proses
            throw new Error(result.message || 'Server responded with an error');
        }
    } catch (error) {
        console.error('Error adding review:', error);
        alert("Gagal menambahkan review: " + error.message);
    }
  };


  async function refreshReviews() {
    try {
        const reviewsContainer = document.getElementById("reviews-container");
        reviewsContainer.innerHTML = '<p>Loading reviews ...</p>';

        const response = await fetch("/review/get-review");
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.json();

        reviewsContainer.innerHTML = '';
        data.reviews.forEach(review => {
            reviewsContainer.innerHTML += "\n" +
            `<div class="shadow-xl w-full rounded-xl bg-zinc-100 px-4 py-6">` +
            `<p class="opacity-40">${review.user} gave <span class="font-bold opacity-100">${review.rating}</span> star to</p>` +
            `<h5 class="text-xl font-bold">${review.book}</h5>` +
            `<p>${review.content}</p>` +
            `</div>`;
        });
    } catch (error) {
        console.error('Error fetching reviews:', error);
        reviewsContainer.innerHTML = '<p>Error loading reviews.</p>';
    }
  }
  refreshReviews();


  // async function addReview() {
  //   const bookId = bookEle.getAttribute("data-value")
  //   console.log(bookEle.getAttribute("data-value"), "ini")
  //   const review = document.getElementById("name").value
  //   const res = await fetch ("/review/create-review/", {
  //     method: "POST",
  //     headers: {
  //       "Content-Type": "application/json"
  //     },
  //     body: JSON.stringify({"review":review, "bookId":bookId})
  //   })
  //   const result = await res.json()
  //   refreshReviews()
  //   document.getElementById("add-review-form").reset()
  //   return false;
  // }

  // document.getElementById("submit_new_review").onclick = addReview

</script>
{% endblock content %}