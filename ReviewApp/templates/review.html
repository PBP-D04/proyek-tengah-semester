{% extends 'base.html' %}

{% block content %}
{% load static %}

<style>
 .col-sm-5.mt-2 {
    float: right;
    margin-bottom: 10px;
  }

  .review-heading {
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 10px;
    margin-bottom: 10px;
  }

  .review-heading a {
    color: #007bff;
    text-decoration: none;
  }

  .review-body {
    margin-top: 10px;
  }

  .review-body p {
    line-height: 1.6;
  }

  .review-form {
    background-color: #efefef;
    padding: 20px;
    border-radius: 10px;
  }

  #comment {
    width: 100%;
    max-width: 730px;
    height: 50px;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    resize: vertical;
  }

  #upload-image {
    margin-bottom: 10px;
  }

  .mt-0.pt-0 {
    border-top: 1px solid #460c90;
  }


  .input-rate {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-bottom: 10px;
  }

  .text-uppercase {
    text-transform: uppercase;
  }

  .font-weight-bold {
    font-weight: bold;
  }

  #post-btn {
    background-color: #460c90;
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
  }

  #post-btn:hover {
    background-color: #2c075c;
  }

  .rate-wrapper {
    display: flex;
    align-items: center;
    transform: rotateY(180deg);
  }

  .rate-wrapper input[type="radio"] {
    display: none;
  }

  .rate-wrapper label {
    display: block;
    cursor: pointer;
    width: 20px;
    height: 20px;
    background-color: rgb(148, 148, 148);
    clip-path: polygon(50% 0%, 61.8% 35%, 98.4% 35%, 68.4% 57.5%, 79.4% 91%, 50% 70%, 20.6% 91%, 31.6% 57.5%, 1.6% 35%, 38.2% 35%);
    margin-right: 5px;
    margin-top: 5px;
    margin-bottom: 10px;
  }

  .rate-wrapper label:hover,
  .rate-wrapper label:hover ~ label {
    background-color: #460c90;
  }

  .rate-wrapper input[type="radio"]:checked ~ label {
    background-color: rgb(255, 217, 0);
  }

  .rate-wrapper input[type="radio"]:checked ~ label:hover,
  .rate-wrapper input[type="radio"]:checked ~ label:hover ~ label {
    background-color: #460c90;
  }

  .form-group {
    margin-bottom: 2px;
  }
</style>



<script src="{% static 'js/firebase-upload.js' %}">

</script>



<!-- REVIEW SECTION -->
<!-- Reviews List Modal -->
<div class="modal fade" id="reviewsModal" tabindex="-1" aria-labelledby="reviewsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewsModalLabel">Reviews</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="reviews-container">
          <!-- Daftar ulasan akan ditampilkan di sini -->
          {% for review in reviews %}
          <div class="review-heading">
            <a class="text-capitalize"><i class="far fa-user mr-1"></i>{{review.user.username}}</a>
            <a class="ml-2"><i class="far fa-clock mr-1"></i>{{review.date_added}}</a>
            <i class="fa fa-star {% if review.rate > 4 %} checked {% endif %}" style="float: right;"></i>
            <!-- ... (other stars) ... -->
          </div>
          <div class="review-body mt-2">
            <p>{{review.review}}</p>
            {% if review.image %}
            <img src="{{ review.image.url }}" alt="Review Image" class="img-fluid mt-2">
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Review Form Modal -->
<div class="modal fade" id="reviewFormModal" tabindex="-1" aria-labelledby="reviewFormModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewFormModalLabel">Add New Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST" id="add-review-form" class="space-y-6" action="#">
          {% csrf_token %}
          <table>
              {{ form.as_table }}
              <tr>
                  <td></td>
                  <td>
                      <input type="submit" value="Add Review" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 hover:cursor-pointer"/>
                      <!-- <button id="submit_new_book" type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Add your book</button> -->
                  </td>
              </tr>
          </table>
      </div>
    </div>
  </div>
</div>

<!-- Trigger buttons -->
<div class="container mt-5">
  <h5 class="text-uppercase font-weight-bold">Reviews</h5>
  <hr class="mt-0 pt-0">
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#reviewFormModal">
      Add Review by AJAX
    </button>
</div>

</div>




<script>
  async function getReview() {
    return fetch("{% url 'ReviewApp:get_review_json' %}").then((res) => res.json())
  }

  async function refreshReviews() {
    const reviewsContainer = document.getElementById("reviews-container");
    reviewsContainer.innerHTML = "";

    const reviews = await getReview()
    reviews.forEach((review) => {
      const reviewElement = document.createElement("div");
      reviewElement.style.padding = "10px";
      reviewElement.style.marginBottom = "10px";


      const reviewText = document.createElement("p");
      console.log(review.fields);
      reviewsContainer += `\n
      <div>
        <h5>${review.fields.user}</h5>
        <p>${review.fields.content}</p>
      </div>`
    })

  }
  refreshReviews();

  async function addReview() {
    const bookId = bookEle.getAttribute("data-value")
    console.log(bookEle.getAttribute("data-value"), "ini")
    const review = document.getElementById("name").value
    const res = await fetch ("/review/create-review/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({"review":review, "bookId":bookId})
    })
    const result = await res.json()
    refreshReviews()
    document.getElementById("add-review-form").reset()
    return false;
  }

  document.getElementById("submit_new_review").onclick = addReview

    // let data = {
    //     'imageUrl': '',
    //     'rate': 5,
    //     'comment':''
    // }
    // const setData = async  () => {
    //    const rateInput =  document.querySelector('input[name="rate"]:checked');
    //    const comment = document.getElementById("comment");
    //    if(rateInput.value){
    //     data.rate = parseInt(rateInput.value)
    //    }
    //    data.comment = comment.value.trim()
    //    const res = await uploadImageByElement('upload-image')
    //    data.imageUrl = res
       
    // }
    // const postBtn = document.getElementById('post-btn')
    // postBtn.addEventListener('click', async ()=> {
    //    await  setData()
    //     const resjson = await fetch('/review/create-review/', {
    //         method:'POST',
    //         headers: {
    //             'Content-Type': 'application/json',
    //         },
    //         body: JSON.stringify(data),
    //     });
    //     const res = await resjson.json()
    //     console.log(res)

    // })
</script>
{% endblock content %}